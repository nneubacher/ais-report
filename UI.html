<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Report AI Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the prompt display */
        #prompt-review-textarea, #final-report-content {
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Wrap long lines */
            max-height: 40vh; /* Limit height and make scrollable */
            min-height: 20vh; /* Ensure a minimum height */
            resize: vertical; /* Allow vertical resizing for textarea */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white text-center">AI Ship Data Analyst</h1>
            <p class="text-sm text-gray-300 text-center mt-1">Upload your CSV to generate an executive summary.</p>
        </div>

        <nav class="p-6 border-b border-gray-200">
            <ol class="flex items-center justify-between w-full space-x-2 sm:space-x-4 text-xs sm:text-sm">
                <li id="step-1" class="flex items-center text-blue-600 font-semibold">
                    <span id="step-1-icon" class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white font-bold text-sm mr-1 sm:mr-2">1</span>
                    <span>Configure</span>
                </li>
                <li class="flex-1 h-px bg-gray-300"></li>
                <li id="step-2" class="flex items-center text-gray-500">
                    <span id="step-2-icon" class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-sm mr-1 sm:mr-2">2</span>
                    <span>Analyze</span>
                </li>
                <li class="flex-1 h-px bg-gray-300"></li>
                <li id="step-3" class="flex items-center text-gray-500">
                    <span id="step-3-icon" class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-sm mr-1 sm:mr-2">3</span>
                    <span>Review</span>
                </li>
                <li class="flex-1 h-px bg-gray-300"></li>
                <li id="step-4" class="flex items-center text-gray-500">
                    <span id="step-4-icon" class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-sm mr-1 sm:mr-2">4</span>
                    <span>Generate</span>
                </li>
                <li class="flex-1 h-px bg-gray-300"></li>
                <li id="step-5" class="flex items-center text-gray-500">
                    <span id="step-5-icon" class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-sm mr-1 sm:mr-2">5</span>
                    <span>Result</span>
                </li>
            </ol>
        </nav>

        <div class="p-8">

            <div id="upload-step">
                 <h2 class="text-lg font-semibold text-gray-800 mb-4">Step 1: Configure Your Analysis</h2>
                
                <label for="file-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m0 0l-3-3m3 3l3-3"></path></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">CSV file (MAX. 5MB)</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept=".csv" />
                </label>

                <div id="file-name-display" class="mt-4 text-sm text-gray-700 font-medium hidden">
                    File selected: <span id="file-name" class="text-blue-600"></span>
                </div>
                
                <div class="mt-6">
                    <label for="analysis-type" class="block text-sm font-medium text-gray-700">Analysis Type</label>
                    <select id="analysis-type" name="analysis-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border" disabled>
                        <option value="fleet_overview">Fleet Overview (Default)</option>
                        <option value="company_deep_dive">Company Deep Dive</option>
                    </select>
                </div>
                
                <div id="company-name-container" class="mt-4 hidden">
                    <label for="company-name-select" class="block text-sm font-medium text-gray-700">Company Name (from 'Name_1' column)</label>
                    <select id="company-name-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border" disabled>
                        <option value="">Upload CSV to see companies...</option>
                    </select>
                </div>

                <div id="error-message" class="mt-4 text-sm text-red-600 font-medium hidden"></div>

                <div class="mt-6 text-right">
                    <button id="analyze-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Analyze Data
                    </button>
                </div>
            </div>
            
            <div id="review-step" class="hidden">
                 <h2 class="text-lg font-semibold text-gray-800 mb-4">Step 3: Review & Edit Generated Prompt</h2>
                 <p class="text-sm text-gray-600 mb-2">This prompt will be sent to the AI. You can edit it if needed.</p>
                 <textarea id="prompt-review-textarea" class="mt-4 p-4 w-full border border-gray-300 rounded-md bg-gray-50 text-sm font-mono focus:ring-blue-500 focus:border-blue-500" rows="10">
                 </textarea>
                 
                 <div class="mt-6 text-right">
                    <button id="generate-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition">
                        Generate Report with This Prompt
                    </button>
                </div>
            </div>


            <div id="processing-step" class="hidden">
                <div class="flex flex-col items-center justify-center min-h-[250px]">
                    <div class="spinner"></div>
                    <h2 id="processing-status" class="mt-4 text-lg font-semibold text-gray-700"></h2>
                    <p class="text-gray-500">This may take a few moments...</p>
                </div>
            </div>

            <div id="complete-step" class="hidden">
                <div class="flex flex-col items-center justify-center min-h-[250px] w-full">
                    <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h2 class="mt-3 text-2xl font-bold text-gray-800">Report Generated!</h2>
                    
                    <div class="mt-4 w-full border-t border-gray-200 pt-4">
                        <h3 class="text-md font-semibold text-gray-700 mb-2">Generated Report Output:</h3>
                        <pre id="final-report-content" class="p-4 border border-gray-200 rounded-md bg-gray-50 overflow-auto text-sm"></pre>
                    </div>

                    <div class="flex flex-wrap justify-center space-x-0 sm:space-x-4 mt-6 w-full">
                        <button id="download-button" class="w-full sm:w-auto px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition">
                            Download Report (.md)
                        </button>
                         <button id="go-back-button" class="w-full sm:w-auto mt-3 sm:mt-0 px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition">
                            ⬅️ Go Back & Edit Prompt
                        </button>
                    </div>
                </div>
            </div>

            </div>
    </div>

    <script>
        // --- DOM Elements ---
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const fileNameEl = document.getElementById('file-name'); 
        const analyzeButton = document.getElementById('analyze-button');
        const errorMessage = document.getElementById('error-message');
        
        const analysisTypeSelect = document.getElementById('analysis-type');
        const companyNameContainer = document.getElementById('company-name-container');
        const companyNameSelect = document.getElementById('company-name-select'); 
        
        const uploadStep = document.getElementById('upload-step');
        const reviewStep = document.getElementById('review-step'); 
        const promptReviewTextarea = document.getElementById('prompt-review-textarea'); // <-- NEW Textarea
        const generateButton = document.getElementById('generate-button'); 
        
        const processingStep = document.getElementById('processing-step');
        const completeStep = document.getElementById('complete-step');
        const finalReportContentEl = document.getElementById('final-report-content'); // <-- NEW Report Display
        const processingStatus = document.getElementById('processing-status');
        
        const downloadButton = document.getElementById('download-button');
        const goBackButton = document.getElementById('go-back-button'); // <-- NEW Go Back Button
        
        // Remove modal elements as they are not used now
        // const showPromptButton = document.getElementById('show-prompt-button');
        // const promptModal = document.getElementById('prompt-modal');
        // const promptContent = document.getElementById('prompt-content');
        // const closeModalButton = document.getElementById('close-modal-button');

        // --- Stepper Elements (Updated for 5 steps) ---
        const steps = {
            1: { li: document.getElementById('step-1'), icon: document.getElementById('step-1-icon') },
            2: { li: document.getElementById('step-2'), icon: document.getElementById('step-2-icon') },
            3: { li: document.getElementById('step-3'), icon: document.getElementById('step-3-icon') },
            4: { li: document.getElementById('step-4'), icon: document.getElementById('step-4-icon') },
            5: { li: document.getElementById('step-5'), icon: document.getElementById('step-5-icon') }
        };
        const checkmarkSVG = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        `; 

        // --- State ---
        let selectedFile = null;
        let currentStep = 1;
        let finalReportContent = ""; 
        let generatedPrompt = ""; // Still store the *original* prompt from /analyze

        // --- Functions ---
        
        /**
         * Updates the stepper UI (Updated for 5 steps)
         */
        function updateStepper(step) {
            currentStep = step;
            // Now iterates up to 5
            for (let i = 1; i <= 5; i++) {
                const stepEl = steps[i];
                if (!stepEl || !stepEl.li || !stepEl.icon) continue;
                
                stepEl.li.classList.remove('text-gray-500', 'text-blue-600', 'text-green-600', 'font-semibold');
                stepEl.icon.classList.remove('bg-gray-300', 'bg-blue-600', 'bg-green-600', 'text-white', 'text-gray-600');
                
                if (i < step) {
                    stepEl.li.classList.add('text-green-600', 'font-semibold');
                    stepEl.icon.classList.add('bg-green-600', 'text-white');
                    stepEl.icon.innerHTML = checkmarkSVG;
                } else if (i === step) {
                    stepEl.li.classList.add('text-blue-600', 'font-semibold');
                    stepEl.icon.classList.add('bg-blue-600', 'text-white');
                    stepEl.icon.innerHTML = i;
                } else {
                    stepEl.li.classList.add('text-gray-500');
                    stepEl.icon.classList.add('bg-gray-300', 'text-gray-600');
                    stepEl.icon.innerHTML = i;
                }
            }
        }
        
        /**
         * Fetches company list from backend (Unchanged)
         */
        async function fetchCompanyList(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            companyNameSelect.innerHTML = '<option value="">Loading companies...</option>';
            companyNameSelect.disabled = true;
            analyzeButton.disabled = true;

            try {
                const response = await fetch('http://127.0.0.1:5000/get-company-list', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                companyNameSelect.innerHTML = '<option value="">-- Select a Company --</option>'; 
                result.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companyNameSelect.appendChild(option);
                });

                companyNameSelect.disabled = false;
                analysisTypeSelect.disabled = false;
                analyzeButton.disabled = false; 

            } catch (error) {
                console.error('Failed to fetch company list:', error);
                showError(error.message);
                companyNameSelect.innerHTML = '<option value="">Error loading companies</option>';
            }
        }

        /**
         * Handles the file selection event (Unchanged)
         */
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            errorMessage.classList.add('hidden'); 
            
            analyzeButton.disabled = true;
            analysisTypeSelect.disabled = true;
            companyNameSelect.disabled = true;
            
            if (selectedFile) {
                if (selectedFile.name.endsWith('.csv')) {
                    fileNameEl.textContent = selectedFile.name;
                    fileNameDisplay.classList.remove('hidden');
                    fetchCompanyList(selectedFile);
                } else {
                    showError('Invalid file type. Please select a .csv file.');
                    selectedFile = null;
                    fileNameDisplay.classList.add('hidden');
                }
            } else {
                fileNameDisplay.classList.add('hidden');
            }
        }

        /**
         * Displays an error message (Unchanged)
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * Resets the UI to the initial upload state (Updated)
         */
        function resetToUpload() {
            uploadStep.classList.remove('hidden');
            reviewStep.classList.add('hidden'); 
            processingStep.classList.add('hidden');
            completeStep.classList.add('hidden');
            
            analyzeButton.disabled = !selectedFile; 
            
            processingStatus.textContent = '';
            updateStepper(1);
            
            // Reset dropdowns
            analysisTypeSelect.value = 'fleet_overview';
            companyNameContainer.classList.add('hidden');
            if (selectedFile) {
                 companyNameSelect.disabled = false;
                 analysisTypeSelect.disabled = false;
            } else {
                companyNameSelect.innerHTML = '<option value="">Upload CSV to see companies...</option>';
                companyNameSelect.disabled = true;
                analysisTypeSelect.disabled = true;
            }
        }

        /**
         * startAnalysis function (Now simpler)
         */
        async function startAnalysis() {
            if (!selectedFile) {
                showError('Please select a file first.');
                return;
            }
            
            const analysisType = analysisTypeSelect.value;
            const companyName = companyNameSelect.value; 
            
            if (analysisType === 'company_deep_dive' && !companyName) {
                showError('Please select a company for the deep dive.');
                return;
            }

            // --- 1. Prepare UI ---
            analyzeButton.disabled = true; 
            uploadStep.classList.add('hidden');
            processingStep.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('analysis_type', analysisType);
            formData.append('company_name', companyName);

            try {
                // --- 2. Call Analyze ---
                updateStepper(2);
                processingStatus.textContent = 'Uploading and analyzing ship data...';

                const responseAnalyze = await fetch('http://127.0.0.1:5000/analyze', {
                    method: 'POST',
                    body: formData, 
                });

                if (!responseAnalyze.ok) {
                    const err = await responseAnalyze.json();
                    throw new Error(err.error || `Server error: ${responseAnalyze.status}`);
                }

                const resultAnalyze = await responseAnalyze.json();
                
                // --- 3. Move to Review Step ---
                generatedPrompt = resultAnalyze.generated_prompt; // Store original
                promptReviewTextarea.value = generatedPrompt; // Display in textarea
                
                processingStep.classList.add('hidden');
                reviewStep.classList.remove('hidden'); 
                updateStepper(3); 

            } catch (error) {
                console.error('Analysis failed:', error);
                if (error instanceof TypeError) { 
                    showError('Connection failed. Is the backend server running?');
                } else {
                    showError(error.message);
                }
                resetToUpload();
            }
        }
        
        /**
         * triggerGeneration function (Updated to read from textarea)
         */
         async function triggerGeneration() {
            // --- NEW: Read potentially edited prompt from textarea ---
            const currentPrompt = promptReviewTextarea.value;
            if (!currentPrompt) {
                showError('Prompt is empty. Cannot generate report.');
                return;
            }
            
            // --- 1. Prepare UI ---
            reviewStep.classList.add('hidden');
            processingStep.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                // --- 2. Call Generate ---
                updateStepper(4); 
                processingStatus.textContent = 'Generating AI insights...';

                const responseGenerate = await fetch('http://127.0.0.1:5000/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: currentPrompt }) // Send current prompt
                });

                if (!responseGenerate.ok) {
                    const err = await responseGenerate.json();
                    throw new Error(err.error || `Server error: ${responseGenerate.status}`);
                }

                const resultGenerate = await responseGenerate.json();

                // --- 3. Finish: Show Completion UI ---
                finalReportContent = resultGenerate.llm_response;
                finalReportContentEl.textContent = finalReportContent; // <-- Display report

                processingStep.classList.add('hidden');
                completeStep.classList.remove('hidden');
                updateStepper(5); 
                
            } catch (error) {
                 console.error('Generation failed:', error);
                if (error instanceof TypeError) { 
                    showError('Connection failed. Is the backend server running?');
                } else {
                    showError(error.message);
                }
                // Go back to review step on generation error
                processingStep.classList.add('hidden');
                reviewStep.classList.remove('hidden'); 
                updateStepper(3);
            }
         }
         
        /**
         * --- NEW: goBackToReview function ---
         * Handles the "Go Back" button click.
         */
         function goBackToReview() {
             completeStep.classList.add('hidden');
             reviewStep.classList.remove('hidden');
             updateStepper(3);
             // Prompt is already in the textarea from before
         }


        /**
         * Generates and downloads the received report (Unchanged)
         */
        function downloadReport() {
            const blob = new Blob([finalReportContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.download = `${selectedFile.name.replace('.csv', '')}_AI_Report.md`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Remove showPrompt and hidePrompt functions ---
        // function showPrompt() { ... }
        // function hidePrompt() { ... }

        // --- Event Listeners ---
        fileUpload.addEventListener('change', handleFileSelect); 
        analyzeButton.addEventListener('click', startAnalysis);
        generateButton.addEventListener('click', triggerGeneration); 
        downloadButton.addEventListener('click', downloadReport);
        goBackButton.addEventListener('click', goBackToReview); // <-- NEW Listener
        
        // Remove modal listeners
        // showPromptButton.addEventListener('click', showPrompt);
        // closeModalButton.addEventListener('click', hidePrompt);
        // promptModal.addEventListener('click', ...);
        
        analysisTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'company_deep_dive') {
                companyNameContainer.classList.remove('hidden');
            } else {
                companyNameContainer.classList.add('hidden');
            }
        });

        // --- Initial State ---
        updateStepper(1);

    </script>
</body>
</html>